<!-- Table Container -->
<div class="shared-data-table">
  
  <!-- Table Header/Toolbar -->
  <div class="table-header" *ngIf="hasActions() || config.globalFilter || config.refreshable">
    <div class="header-left">
      <!-- Global Search -->
      <div class="global-search" *ngIf="config.globalFilter">
        <span class="p-input-icon-left">
          <i class="pi pi-search"></i>
          <input 
            pInputText 
            type="text" 
            [placeholder]="'Search ' + (config.data.length || 0) + ' items...'"
            [value]="globalFilterValue()"
            (input)="onGlobalFilter($event)"
            class="global-filter-input">
        </span>
      </div>

      <!-- Selection Count -->
      <div class="selection-count" *ngIf="hasSelection() && selectedItems().length > 0">
        <p-tag 
          [value]="selectedItems().length + ' selected'" 
          severity="info" 
          icon="pi pi-check-circle">
        </p-tag>
      </div>
    </div>

    <div class="header-right">
      <!-- Table Actions -->
      <div class="table-actions" *ngIf="config.actions">
        <p-button 
          *ngFor="let action of config.actions"
          [label]="action.label"
          [icon]="action.icon"
          [severity]="action.severity || 'primary'"
          [disabled]="action.requiresSelection && selectedItems().length === 0"
          [pTooltip]="action.tooltip"
          (onClick)="executeAction(action)"
          size="small">
        </p-button>
      </div>

      <!-- Bulk Actions -->
      <div class="bulk-actions" *ngIf="config.bulkActions && selectedItems().length > 0">
        <p-button 
          *ngFor="let action of config.bulkActions"
          [label]="action.label"
          [icon]="action.icon"
          [severity]="action.severity || 'secondary'"
          [disabled]="
            (action.minSelection && selectedItems().length < action.minSelection) ||
            (action.maxSelection && selectedItems().length > action.maxSelection)
          "
          [pTooltip]="action.tooltip"
          (onClick)="executeBulkAction(action)"
          size="small">
        </p-button>
      </div>

      <!-- Refresh Button -->
      <p-button 
        *ngIf="config.refreshable"
        icon="pi pi-refresh" 
        [loading]="loading()"
        severity="secondary"
        pTooltip="Refresh"
        (onClick)="onRefresh()"
        size="small">
      </p-button>

      <!-- Column Manager -->
      <p-button 
        icon="pi pi-cog" 
        severity="secondary"
        pTooltip="Manage Columns"
        (onClick)="showColumnManager()"
        size="small">
      </p-button>

      <!-- Export Menu -->
      <p-button 
        *ngIf="config.exportOptions"
        icon="pi pi-download" 
        severity="secondary"
        pTooltip="Export"
        (onClick)="exportCSV()"
        size="small">
      </p-button>
    </div>
  </div>

  <!-- Data Table -->
  <p-table
    #dataTable
    [value]="config.data"
    [loading]="loading()"
    [paginator]="config.paginator"
    [rows]="config.rows || 10"
    [rowsPerPageOptions]="config.rowsPerPageOptions || [10, 25, 50]"
    [sortField]="config.sortField"
    [sortOrder]="config.sortOrder || 1"
    [multiSortMeta]="config.multiSortMeta"
    [globalFilterFields]="config.globalFilterFields"
    [selectionMode]="config.selectionMode"
    [(selection)]="config.selectedItems"
    dataKey="id"
    [responsiveLayout]="config.responsiveLayout || 'scroll'"
    [lazy]="config.lazy"
    [totalRecords]="config.totalRecords || 0"
    [virtualScroll]="config.virtualScroll"
    [scrollable]="config.scrollable"
    [scrollHeight]="config.scrollHeight"
    [resizableColumns]="config.resizableColumns"
    [reorderableColumns]="config.reorderableColumns"
    [autoLayout]="config.autoLayout"
    (onRowSelect)="onRowSelect($event)"
    (onRowUnselect)="onRowUnselect($event)"
    (onSelectAllChange)="onSelectAllChange($event)"
    (onSort)="onSort($event)"
    (onFilter)="onFilter($event)"
    (onPage)="onPage($event)"
    (onLazyLoad)="onLazyLoad($event)"
    styleClass="shared-table">

    <!-- Table Header -->
    <ng-template pTemplate="header">
      <tr>
        <th *ngFor="let col of visibleColumns()"
            [style.width]="col.width"
            [style.min-width]="col.minWidth"
            [class]="col.styleClass"
            [pSortableColumn]="col.sortable ? getFieldAsString(col.field) : undefined">
          <div class="flex align-items-center">
            {{ col.header }}
            <p-sortIcon 
              *ngIf="col.sortable" 
              [field]="getFieldAsString(col.field)">
            </p-sortIcon>
          </div>
        </th>
      </tr>
    </ng-template>

    <!-- Table Body -->
    <ng-template pTemplate="body" let-item let-rowIndex="rowIndex">
      <tr>
        <td *ngFor="let col of visibleColumns()" 
            [class]="col.styleClass">
          
          <ng-container [ngSwitch]="col.type">
            
            <!-- Status Column -->
            <div *ngSwitchCase="'status'" class="status-cell">
              <p-tag 
                [value]="getStatusConfig(getFieldValue(item, col.field)).label"
                [severity]="getStatusConfig(getFieldValue(item, col.field)).severity"
                [icon]="getStatusConfig(getFieldValue(item, col.field)).icon">
              </p-tag>
            </div>

            <!-- Priority Column -->
            <div *ngSwitchCase="'priority'" class="priority-cell">
              <p-tag 
                [value]="getPriorityConfig(getFieldValue(item, col.field)).label"
                [severity]="getPriorityConfig(getFieldValue(item, col.field)).severity"
                [icon]="getPriorityConfig(getFieldValue(item, col.field)).icon">
              </p-tag>
            </div>

            <!-- User Column -->
            <div *ngSwitchCase="'user'" class="user-cell">
              <div class="user-info">
                <p-avatar 
                  [image]="getUserAvatar(getFieldValue(item, col.field))"
                  [label]="getUserDisplayName(getFieldValue(item, col.field)).charAt(0)"
                  size="normal"
                  shape="circle"
                  styleClass="user-avatar">
                </p-avatar>
                <span class="user-name">{{ getUserDisplayName(getFieldValue(item, col.field)) }}</span>
              </div>
            </div>

            <!-- Badge Column -->
            <div *ngSwitchCase="'badge'" class="badge-cell">
              <p-badge 
                [value]="getFieldValue(item, col.field)"
                severity="info">
              </p-badge>
            </div>

            <!-- Boolean Column -->
            <div *ngSwitchCase="'boolean'" class="boolean-cell">
              <i [class]="getFieldValue(item, col.field) ? 'pi pi-check text-green-500' : 'pi pi-times text-red-500'"></i>
            </div>

            <!-- Link Column -->
            <div *ngSwitchCase="'link'" class="link-cell">
              <a href="#" class="table-link">
                <i class="pi pi-external-link"></i>
                {{ getFieldValue(item, col.field) }}
              </a>
            </div>

            <!-- Date Column -->
            <div *ngSwitchCase="'date'" class="text-cell">
              {{ getFieldValue(item, col.field) | date:'short' }}
            </div>

            <!-- DateTime Column -->
            <div *ngSwitchCase="'datetime'" class="text-cell">
              {{ getFieldValue(item, col.field) | date:'medium' }}
            </div>

            <!-- Number Column -->
            <div *ngSwitchCase="'number'" class="text-cell" [style.text-align]="col.align || 'right'">
              {{ formatCellValue(item, col) }}
            </div>

            <!-- Currency Column -->
            <div *ngSwitchCase="'currency'" class="text-cell" [style.text-align]="col.align || 'right'">
              {{ formatCellValue(item, col) }}
            </div>

            <!-- Percentage Column -->
            <div *ngSwitchCase="'percentage'" class="text-cell" [style.text-align]="col.align || 'right'">
              {{ formatCellValue(item, col) }}
            </div>

            <!-- Actions Column -->
            <div *ngSwitchCase="'actions'" class="row-actions">
              <p-button 
                *ngFor="let action of config.rowActions"
                [icon]="action.icon"
                [severity]="action.severity || 'secondary'"
                [disabled]="isActionDisabled(action, item)"
                [pTooltip]="action.tooltip || action.label"
                (onClick)="executeRowAction(action, item)"
                size="small"
                [outlined]="true">
              </p-button>
            </div>

            <!-- Default Text Column -->
            <div *ngSwitchDefault class="text-cell" [style.text-align]="col.align || 'left'">
              <ng-container *ngIf="col.template; else defaultText">
                <ng-container *ngTemplateOutlet="col.template; context: { $implicit: item, field: col.field, value: getFieldValue(item, col.field) }"></ng-container>
              </ng-container>
              <ng-template #defaultText>
                {{ getFieldValue(item, col.field) }}
              </ng-template>
            </div>

          </ng-container>
          
        </td>
      </tr>
    </ng-template>

    <!-- Empty State -->
    <ng-template pTemplate="emptymessage">
      <tr>
        <td [attr.colspan]="visibleColumns().length">
          <div class="empty-state">
            <div class="empty-content">
              <ng-container *ngIf="emptyTemplate; else defaultEmpty">
                <ng-container *ngTemplateOutlet="emptyTemplate"></ng-container>
              </ng-container>
              <ng-template #defaultEmpty>
                <i class="pi pi-info-circle empty-icon"></i>
                <h3>{{ config.emptyMessage || 'No data found' }}</h3>
                <p>Try adjusting your filters or adding new items.</p>
              </ng-template>
            </div>
          </div>
        </td>
      </tr>
    </ng-template>

  </p-table>

  <!-- Loading Overlay -->
  <div class="loading-overlay" *ngIf="loading()">
    <div class="loading-content">
      <ng-container *ngIf="loadingTemplate; else defaultLoading">
        <ng-container *ngTemplateOutlet="loadingTemplate"></ng-container>
      </ng-container>
      <ng-template #defaultLoading>
        <app-loading-spinner 
          type="skeleton"
          size="medium"
          message="Loading data..."
          [customSkeletons]="getTableSkeletons()">
        </app-loading-spinner>
      </ng-template>
    </div>
  </div>

</div>